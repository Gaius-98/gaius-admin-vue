import{g as b,s as h}from"./index-CW3wiaTU.js";import{d as O}from"./gaius-utils-FbSzq_Sh.js";import{F as j,g as L,I as P,E as N,m as $,n as V,o as m,H as R,p as T,e as q,J as H}from"./ant-design-vue-yNpjrsH-.js";import{c as J}from"./lodash-es-PU94eZQX.js";import{L as K,i as U,r as F,h as c,ag as z}from"./@vue-erW_et9m.js";const A=n=>{const e=/\$\{([^}]+)\}/g,t=n.match(e);return t?t.map(a=>{const r=a.trim().replace(/formData./g,"");return r.substring(2,r.length-1)}):[]},B=(n,e)=>{const t=/\$\{([^}]+)\}/g;return n.replace(t,(r,u)=>{const s=u.trim();return b({formData:e},s)})},E=(n,e)=>{const t=B(n,e);return new Function(`return ${t}`)()},G=(n,e,t,a,r)=>{let u;switch(t){case"string":u=c(P,{...r,value:b(n,e),onChange:s=>{h(n,e,s.target.value),a.pubSub.onPublish(e),a.onChange({formData:n,field:e,value:s.target.value})}});break;case"textarea":u=c(H,{...r,value:b(n,e),onChange:s=>{h(n,e,s.target.value),a.pubSub.onPublish(e),a.onChange({formData:n,field:e,value:s.target.value})}});break;case"select":u=c(q,{...r,options:a.options[e]||[],value:b(n,e),onChange:s=>{h(n,e,s),a.pubSub.onPublish(e),a.onChange({formData:n,field:e,value:s})}});break;case"number":u=c(T,{...r,value:b(n,e),onChange:s=>{h(n,e,s),a.pubSub.onPublish(e),a.onChange({formData:n,field:e,value:s})}});break;case"date":u=c(R,{...r,value:b(n,e),onChange:s=>{h(n,e,s),a.pubSub.onPublish(e),a.onChange({formData:n,field:e,value:s})}});break;case"tree":u=c(m,{...r,options:a.options[e]||[],value:b(n,e),onChange:s=>{h(n,e,s),a.onChange({formData:n,field:e,value:s})}});break;case"radio":u=c(V,{...r,value:b(n,e),onChange:s=>{h(n,e,s.target.value),a.pubSub.onPublish(e),a.onChange({formData:n,field:e,value:s.target.value})}},{default:()=>(a.options[e]||[]).map(s=>c($,{value:s.value,key:s.value},{default:()=>s.label}))});break;case"switch":u=c(N,{checked:b(n,e),onChange(s){h(n,e,s),a.pubSub.onPublish(e),a.onChange({formData:n,field:e,value:s})}});break;default:u=c(P,{...r,value:b(n,e),onChange:s=>{h(n,e,s.target.value),a.pubSub.onPublish(e),a.onChange({formData:n,field:e,value:s.target.value})}});break}return u},M=(n,e,t,a)=>{const{type:r,label:u,component:s,rules:_,tooltip:w}=t;let d;if(s!=null&&s.name){const{name:v}=s,f=J(s);if(Reflect.deleteProperty(f,"onChange"),!a.sfProvideEL[v])throw new Error(`${v} is not registered,provide('sfProvideEL','${v}',Component)`);d=c(a.sfProvideEL[v],{...f,formData:n,value:b(n,e),onChange:C=>{if(n[e]=C,h(n,e,C),s.onChange)try{s.onChange(C,n,e)}catch(g){throw new Error(g)}}})}else d=G(n,e,r,a,s);return a.visibleInfo[e]&&c(L,{label:u,name:e,rules:_,tooltip:w},{default:()=>[d]})},I={name:"SchemaForm",props:{layout:{type:Object},properties:{type:Object},formData:{type:Object,required:!0}},setup(n){const{layout:e,properties:t,formData:a}=K(n),r=U("sfProvideEL"),u=F({}),s=Object.entries(t.value).filter(([,o])=>{var l,i;return((l=o==null?void 0:o.component)==null?void 0:l.dataSource)||((i=o==null?void 0:o.component)==null?void 0:i.asyncData)}),_=async(o,l)=>{const{dataSource:i,asyncData:p}=l.component;i?u.value[o]=i:u.value[o]=await p(a.value,o)};s.map(async([o,l])=>{await _(o,l)});const w=o=>{const[l,i]=Object.entries(t.value).find(([p])=>o==p);i&&_(l,i)},d=new O,v=o=>{var p,S;const{field:l}=o,i=(S=(p=t.value[l])==null?void 0:p.component)==null?void 0:S.onChange;i&&i(o)},f=z(),C=()=>{Object.entries(t.value).map(([o,l])=>{if(typeof l.show>"u")g.value[o]=!0;else if(typeof l.show=="boolean")g.value[o]=l.show;else if(typeof l.show=="string"){const i=l.show;g.value[o]=E(i,a.value),A(i).map(S=>{d.onSubscribe(S,()=>{g.value[o]=E(i,a.value)})})}})},g=F({});return C(),{layout:e,properties:t,refreshOption:w,formData:a,options:u,visibleInfo:g,pubSub:d,sfProvideEL:r,onChange:v,expose:f}},render:n=>c(j,{...n.layout},{default:()=>[...Object.entries(n.properties).map(([e,t])=>M(n.formData,e,t,n))]})};export{I as S};
